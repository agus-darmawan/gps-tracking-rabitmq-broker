# ============================================================================
# RabbitMQ Configuration for GPS Tracking System
# ============================================================================
# This configuration is optimized for high-throughput GPS tracking data
# from Protrack devices to backend servers

# ============================================================================
# NETWORK LISTENERS
# ============================================================================

# AMQP 0-9-1 and AMQP 1.0 port
listeners.tcp.default = 5672

# ============================================================================
# MANAGEMENT PLUGIN
# ============================================================================

# Management UI HTTP listener
management.tcp.port = 15672
management.tcp.ip = 0.0.0.0

# Load queue definitions on startup
management.load_definitions = /etc/rabbitmq/definitions.json

# Management UI rate limit (requests per user)
management.rates_mode = basic

# ============================================================================
# MQTT PLUGIN (for GPS devices using MQTT protocol)
# ============================================================================

# Enable MQTT listener
mqtt.listeners.tcp.default = 1883

# Disable anonymous MQTT access (require authentication)
mqtt.allow_anonymous = false

# Default virtual host for MQTT connections
mqtt.vhost = /

# Default exchange for MQTT messages
mqtt.exchange = gps.tracking.exchange

# MQTT subscription TTL (24 hours)
mqtt.subscription_ttl = 86400000

# MQTT prefetch count
mqtt.prefetch = 10

# ============================================================================
# MEMORY MANAGEMENT
# ============================================================================

# Memory high watermark (60% of available RAM)
# When this threshold is reached, RabbitMQ will block publishers
vm_memory_high_watermark.relative = 0.6

# Alternative: Set absolute memory limit (uncomment if needed)
# vm_memory_high_watermark.absolute = 2GB

# Memory calculation strategy
vm_memory_calculation_strategy = rss

# Paging threshold (50% of memory high watermark)
vm_memory_high_watermark_paging_ratio = 0.5

# ============================================================================
# DISK SPACE MANAGEMENT
# ============================================================================

# Minimum free disk space required (2GB)
disk_free_limit.absolute = 2GB

# Alternative: Percentage based (uncomment if needed)
# disk_free_limit.relative = 1.0

# ============================================================================
# LOGGING
# ============================================================================

# Log levels: debug, info, warning, error, critical, none
log.file.level = info
log.console = true
log.console.level = info

# Log file rotation
log.file.rotation.date = $D0
log.file.rotation.size = 10485760
log.file.rotation.count = 5

# Connection log level (reduce noise in production)
log.connection.level = warning

# ============================================================================
# QUEUE SETTINGS
# ============================================================================

# Queue master location strategy
queue_master_locator = min-masters

# Default queue type (classic or quorum)
default_queue_type = classic

# ============================================================================
# CONNECTION SETTINGS
# ============================================================================

# Heartbeat interval (seconds)
# Recommended: 60 seconds for GPS devices
heartbeat = 60

# Max frame size (bytes)
frame_max = 131072

# Max number of channels per connection
channel_max = 2047

# ============================================================================
# CONSUMER SETTINGS
# ============================================================================

# Consumer timeout (30 minutes)
# Consumers must acknowledge messages within this time
consumer_timeout = 1800000

# ============================================================================
# MESSAGE STORE SETTINGS
# ============================================================================

# Message store index embed threshold
msg_store_index_embed_msgs_below = 4096

# Persistent message store credit flow
msg_store_credit_disc_bound = {4000, 8000}

# ============================================================================
# QUEUE INDEX SETTINGS
# ============================================================================

# Queue index embed messages threshold
queue_index_embed_msgs_below = 4096

# ============================================================================
# CLUSTERING (Uncomment if using cluster)
# ============================================================================

# Cluster name
# cluster_name = tracking-cluster

# Cluster formation peer discovery backend
# cluster_formation.peer_discovery_backend = rabbit_peer_discovery_classic_config

# Cluster nodes
# cluster_formation.classic_config.nodes.1 = rabbit@node1
# cluster_formation.classic_config.nodes.2 = rabbit@node2

# ============================================================================
# SSL/TLS (Uncomment if using SSL)
# ============================================================================

# SSL listeners
# listeners.ssl.default = 5671

# SSL options
# ssl_options.cacertfile = /path/to/ca_certificate.pem
# ssl_options.certfile = /path/to/server_certificate.pem
# ssl_options.keyfile = /path/to/server_key.pem
# ssl_options.verify = verify_peer
# ssl_options.fail_if_no_peer_cert = false

# ============================================================================
# PERFORMANCE TUNING
# ============================================================================

# Hipe compilation (Erlang optimization)
# hipe_compile = false

# Collect statistics (disable in production for better performance)
collect_statistics = coarse
collect_statistics_interval = 5000

# Background GC (garbage collection)
background_gc_enabled = true
background_gc_target_interval = 60000

# ============================================================================
# SHOVEL PLUGIN (Uncomment if needed for data replication)
# ============================================================================

# loopback_users.guest = false

# ============================================================================
# DEFAULT USER TAGS
# ============================================================================

# Default tags for administrator
default_user_tags.administrator = management

# Default permissions for new virtual hosts
default_vhost = /
default_user = tracking_admin
default_pass = tracking_secure_2024
default_permissions.configure = .*
default_permissions.read = .*
default_permissions.write = .*

# ============================================================================
# SECURITY
# ============================================================================

# Disable guest user for security
loopback_users.guest = true

# Password hashing algorithm (SHA256 recommended)
password_hashing_module = rabbit_password_hashing_sha256

# ============================================================================
# TCP SETTINGS
# ============================================================================

# TCP buffer size
tcp_listen_options.backlog = 128
tcp_listen_options.nodelay = true
tcp_listen_options.linger.on = true
tcp_listen_options.linger.timeout = 0
tcp_listen_options.exit_on_close = false

# ============================================================================
# PROMETHEUS MONITORING (Uncomment if using Prometheus)
# ============================================================================

# prometheus.tcp.port = 15692
# prometheus.tcp.ip = 0.0.0.0

# ============================================================================
# ADDITIONAL SETTINGS FOR GPS TRACKING
# ============================================================================

# Max message size (10MB for GPS data with attachments)
max_message_size = 10485760

# Channel operation timeout
channel_operation_timeout = 15000

# Mirroring sync batch size
mirroring_sync_batch_size = 4096

# ============================================================================
# END OF CONFIGURATION
# ============================================================================